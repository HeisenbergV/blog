---
title: "Redis源码阅读 0"
categories: [coder]
tags: [redis, 源码]
date: 2019-11-01
---

## 目标
提高c语言水平
学习redis
学习redis设计


## 开始
环境macOS
编辑器 vscode
下载 redis3.0源码 
编译
运行redis-server
使用redis-cli进行联动

## 让代码能调试
[vscode 调试c出现的问题](https://code.visualstudio.com/docs/languages/cpp#_intellisense)

## 如何阅读
调试走几个命令
了解整体流程：http://zhangtielei.com/posts/blog-redis-how-to-start.html
熟悉每一个模块：http://blog.huangz.me/diary/2014/how-to-read-redis-source-code.html
看看视频：https://search.bilibili.com/all?keyword=redis%E6%BA%90%E7%A0%81&order=totalrank&duration=0&tids_1=0
详细；http://wiki.jikexueyuan.com/project/redis/preliminary-redis.html
书：https://www.kancloud.cn/kancloud/redisbook/63827

## 数据结构
### sds
C中柔性数组（flexible array）
sdslen函数的逻辑问题：https://blog.csdn.net/u014303647/article/details/88740109

### 字典
负载因子
https://www.nowcoder.com/questionTerminal/cede8f68a7d24256895a3a632508a4eb?page=1&onlyReference=false

写实拷贝（copy on write)
https://www.cnblogs.com/biyeymyhjob/archive/2012/07/20/2601655.html

每次add操作会检查是否需要执行rehash操作：
1. 当空间不足
2. 当负载因子超过5



redis的基础数据结构：sds, ziplist, skiplist, dict, intset, linklist
redis将基础数据结构组合封装成 对象（redisObject） 为客户端提供：string，set，zset，hash，list 5种数据结构
根据不同的编码方式对相同的对象进行操作，数据的变动还会引发编码方式的转换
redis在处理客户端命令时会根据对象类型进行检验，此对象是否支持这个命令，也会利用多态性，用相同的命令处理不同的对象类型
对象有引用计数字段，用来实现垃圾回收，当多个键的值相同时可以共享对象内容，从而节省内存，只需要指向同一个内存，然后将被共享的对象引用计数加一。
但是Redis只对整数值的字符串对象进行共享，因为进行共享需要对要创建的和已共享的对象进行比较验证是否相同，整数很好验证复杂度为0(1)，但是字符串或者其他结构的
时间复杂度会很大，更消耗cpu时间，所以只进行整数共享,还有一些常用字符，命令等：OK, DEL


垃圾回收的处理
1. 启动服务的时候设置一个函数调用，这个函数每次在事件处理前调用一次
2. 如果是主服务就会执行一次  过期建清理 模式为：ACTIVE_EXPIRE_CYCLE_SLOW
RDB,AOF落地处理
