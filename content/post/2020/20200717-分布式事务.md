---
title: "稀缺"
categories: [coder]
tags: [分布式]
date: 2020-07-16
draft: true

---



## 问题由来
tsp项目请求 et6或者mt4 api，并会将结果记录数据库。
但如果api 请求成功，入库失败怎么办？ api没有回退能力
拆合股

如果要请求多个api，必须保证api之间是事务性的怎么办？

一般的事务一致性， 数据库提供的本地事务保障一致性，但必须是同一个数据库操作


## 预备知识

### CAP理论
- C：Consistency 一致性：同一数据的多个副本是否实时相同。
- A：Availability 可用性：一定时间内系统返回一个明确的结果 则称为该系统可用。
- P：Partition tolerance 分区容错性：将同一服务分布在多个系统中，从而保证某一个系统宕机，仍然有其他系统提供相同的服务。


### BASE理论
- BA：Basic Available 基本可用：整个系统在某些不可抗力的情况下，仍然能够保证“可用性”，即一定时间内仍然能够返回一个明确的结果。只不过“基本可用”和“高可用”的区别是：

4板斧：延迟响应（获取订单），体验降级（禁止非交易请求），过载保护，流量削峰（12306购票）

- S：Soft State：柔性状态，为了可用性，在某一时刻，同一数据的不同副本的状态，可以不需要实时一致。算是BA的过渡
- E：Eventual Consisstency：最终一致性，同一数据的不同副本的状态，可以不需要实时一致，但一定要保证经过一定时间后仍然是一致的。

## 分布式事务
### 解决方案 协议
#### 二阶段提交 (2PC: Two-Phase Commit)
关键就一个字，试探。
比一般的请求，多了一步试探操作，
第一阶段：提交请求，等待所有服务的回应，每个服务锁定操作
结果：
1. 全体通过
请求方，发起commit操作，确认最终执行，服务方执行，并释放资源

2. 一个或多个失败
3. 超时
因为没达成一致，所以通知服务，取消刚才的操作，释放资源


第二阶段：如果全体通过，则发起事务执行。

缺点：
1. 单点问题：事务发起者，如果宕机，所有执行者全部因为阻塞状态，无法继续服务
2. 同步阻塞：锁无论是不是分布式都影响问题，分布式更是影响整个系统。
3. 数据不一致性：前面都成功了，但提交commit或者回滚的时候因为网络问题，执行者未收到消息，则还是会产生不一致性。

如何解决？三阶段提交
#### 三阶段提交
1. 超时机制：执行者未收到消息，则在一段时间后自动取消锁定
2. 互询机制：既然发起者因为某些原因无法继续发指令，让执行者互相询问当前状态，找到一个非ready状态的服务模仿他，如果全都是ready状态，那么说明全都未接收到消息，则说明发起者异常，全体进行超时处理。

#### Paxos

#### Raft

tcc
 请求两个高可用 管好自己就行
### 解决方案
- 全局事务（DTP模型 Distributed Transaction Processing Reference Model）
- 基于可靠消息服务的分布式事务
- TCC
    try cache
    
- 最大努力通知


### 细节
## 总结
### 业务方面来去除事务性操作
1. 拆合股因为周末执行，这种意外可以依靠日志解决，先写日志，再api，数据库请求。出问题，发异常，手动解决。
2. api保障幂等性


## 参考
https://www.cnblogs.com/CSC20190701/p/12820170.html#_label2
https://segmentfault.com/a/1190000012534071
https://servicecomb.apache.org/docs/distributed_saga_3/
https://xiaomi-info.github.io/2020/01/02/distributed-transaction/
