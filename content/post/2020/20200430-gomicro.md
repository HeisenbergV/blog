---
title: "go-micro"
categories: [code]
tags: [微服务,go-micro]
date: 2020-04-30
---

New-->Init-->Run
### New
```go
type Service interface {
	// The service name
	Name() string
	// Init initialises options
	Init(...Option)
	// Options returns the current options
	Options() Options
	// Client is used to call services
	Client() client.Client
	// Server is for handling requests and events
	Server() server.Server
	// Run the service
	Run() error
	// The service implementation
	String() string
}
```

如果没有对Options赋值，则默认创建：
server：rpcServer
name：`go.micro.server`
client：rpcClient
broker：httpbroker
transport：http
registry：mdns

```go
	opt := Options{
		Auth:      auth.DefaultAuth,
		Broker:    broker.DefaultBroker,
		Cmd:       cmd.DefaultCmd,
		Config:    config.DefaultConfig,
		Client:    client.DefaultClient,
		Server:    server.DefaultServer,
		Store:     store.DefaultStore,
		Registry:  registry.DefaultRegistry,
		Runtime:   runtime.DefaultRuntime,
		Transport: transport.DefaultTransport,
		Context:   context.Background(),
		Signal:    true,
	}
```

一个进程，一个service 下会有 client，server两个主要服务，依靠：transort提供send，recv
broker提供异步通信，消息队列。codec解码器，register服务注册发现，客户端还有selector选择器。
以上这些都是interface，实现相应接口，可以制定个性化模块。


### Init
New和Init阶段，都能利用Options替换之前的组件。
也可以利用环境变量`MICRO_PLUGIN`更换组件

### Run
1. BeforeStart
2. Start
3. AfterStart
4. 阻塞直到进程退出

Server
#### 等待连接
broker：
使用subscribe注册事件，
在Connect建立连接，run监听事件
来了事件执行回调函数

message：
将ServeConn注册到Accept等待请求
分为同步与异步：
异步：如果消息header定义的位topic，则将消息封装位event messsage加入到消息队列（由roter模块处理），并返回response 
什么时候处理队列的消息呢？

同步：codec->roter->执行对应函数->response

#### 注册中心，心跳
每隔指定时间，

Client：
利用broker->Publish发送事件
利用Call发送请求：
Call->next():selector选择一个服务->封装消息发送请求->loop:request：timeout，retries->reponse

